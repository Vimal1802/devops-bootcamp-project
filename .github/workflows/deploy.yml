name: Build and Deploy
on:
  push:
    branches:
      - main
  workflow_dispatch:     

permissions:
  id-token: write
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-oidc-role
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: devops-bootcamp/final-project-vimaldeep
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG ./app
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest ./app
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-oidc-role
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Trigger Deployment via SSM
        run: |
          # 1. Sends the command to the Ansible Controller via Tag
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Name,Values=Ansible Controller" \
            --parameters 'commands=[
              "cd /home/ubuntu/ansible",
              "sudo -u ubuntu /home/ubuntu/.local/bin/ansible-playbook web-server.yml -e \"image_tag=${{ github.sha }}\""
            ]' \
            --query "Command.CommandId" \
            --output text)
          
          echo "Command sent! ID: $COMMAND_ID"

          # 1.5 PAUSE: Give AWS 15 seconds to index the Command ID. 
          # This prevents the "InvocationDoesNotExist" error.
          echo "Waiting for AWS to index command ID..."
          sleep 15
          # --- AMENDMENT END ---
          
          # ... (Your steps 1, 1.5, and 2 remain the same) ...

          # 2. Forces GitHub to wait for Ansible to finish. 
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.INSTANCE_ID }}"

          # 2.5. CHECK FINAL STATUS
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.INSTANCE_ID }}" \
            --query "Status" \
            --output text)

          # 3. FETCH AND PRINT ANSIBLE LOGS
          echo "--- START OF ANSIBLE OUTPUT ---"
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.INSTANCE_ID }}" \
            --query "StandardOutputContent" \
            --output text
          echo "--- END OF ANSIBLE OUTPUT ---"

          # 4. FAIL THE GITHUB ACTION IF COMMAND FAILED
          if [ "$STATUS" != "Success" ]; then
            echo "Deployment Failed with status: $STATUS"
            # Optional: Print error output if it exists
            aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ secrets.INSTANCE_ID }}" \
              --query "StandardErrorContent" \
              --output text
            exit 1
          fi
