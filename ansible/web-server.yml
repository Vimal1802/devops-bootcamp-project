- name: Install AWS CLI and Docker
  hosts: web_server
  become: true

  vars:
    # This matches the folder we just created on the Web Server
    ecr_url: "927428187886.dkr.ecr.ap-southeast-1.amazonaws.com/devops-bootcamp/final-project-vimaldeep"
    ecr_registry: "927428187886.dkr.ecr.ap-southeast-1.amazonaws.com"
    app_path: "/home/ubuntu/"

  # 1. We use pre_tasks to ensure AWS CLI installs BEFORE the Docker role runs
  pre_tasks:
    - name: Install AWS CLI v2 dependencies
      ansible.builtin.apt:
        name:
          - unzip
          - curl
        state: present
        update_cache: yes

    - name: Download and Install AWS CLI v2
      ansible.builtin.shell: |
        if ! command -v aws &> /dev/null; then
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
          unzip -o /tmp/awscliv2.zip -d /tmp/
          /tmp/aws/install
          rm -rf /tmp/aws /tmp/awscliv2.zip
        fi
      args:
        executable: /bin/bash
      changed_when: false

  # 2. Run the heavy Docker Role
  roles:
    - role: geerlingguy.docker
      vars:
        docker_install_compose: true
        docker_users: ["ubuntu"]

  # 3. Add your deployment tasks here (ECR Login, Pull, Run)
  tasks:
    - name: Login to Amazon ECR
      ansible.builtin.shell: |
        aws ecr get-login-password --region ap-southeast-1 | \
        docker login --username AWS --password-stdin {{ ecr_registry }}
      changed_when: false

    - name: Pull and Restart Application
      ansible.builtin.shell: |
        export ECR_URL="{{ ecr_url }}"
        export IMAGE_TAG="{{ image_tag }}"
        export USER_NAME="VIMALDEEP SINGH WATHAN"
        docker compose -f {{ app_path }}/docker-compose.yml pull
        docker compose -f {{ app_path }}/docker-compose.yml up -d --force-recreate
      args:
        executable: /bin/bash
