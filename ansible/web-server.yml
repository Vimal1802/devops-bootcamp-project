---
- name: Deploy DevOps Web App with ECR Integration
  hosts: web_server
  become: true

  vars:
    # These variables are passed via the -e flag in your SSM command
    # ecr_url: "..."
    # ecr_registry: "..."
    # image_tag: "..."
    app_path: "/var/www/my-devops-project"

  roles:
    - role: geerlingguy.docker
      vars:
        docker_install_compose: true
        docker_users: ["ubuntu"]

  tasks:
    # ==========================================================
    # 1. PREPARE SERVER ENVIRONMENT
    # ==========================================================
    - name: Ensure deployment directory exists
      ansible.builtin.file:
        path: "{{ app_path }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Install AWS CLI dependencies (required for ECR login)
      ansible.builtin.apt:
        name: 
          - python3-pip
          - unzip
        state: present
        update_cache: yes

    # ==========================================================
    # 2. DEPLOY CONFIGURATION FROM CONTROLLER
    # ==========================================================
    - name: Copy docker-compose file from Controller to Server
      ansible.builtin.copy:
        # This assumes docker-compose.yml is in the same folder as this playbook
        src: "./docker-compose.yml" 
        dest: "{{ app_path }}/docker-compose.yml"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Login to Amazon ECR
      ansible.builtin.shell: |
        aws ecr get-login-password --region ap-southeast-1 | \
        docker login --username AWS --password-stdin {{ ecr_registry }}
      changed_when: false

    - name: Update image tag to the specific GitHub SHA
      ansible.builtin.replace:
        path: "{{ app_path }}/docker-compose.yml"
        regexp: 'image:.*'
        replace: "image: {{ ecr_url }}:{{ image_tag }}"

    # ==========================================================
    # 3. RUN APPLICATION
    # ==========================================================
    - name: Pull and Run Application with Docker Compose
      community.docker.docker_compose_v2:
        project_src: "{{ app_path }}"
        state: present
        pull: always
        remove_orphans: yes
      environment:
        USER_NAME: "Vimaldeep Singh Wathan"
