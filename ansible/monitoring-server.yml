---
# 1. DISTRIBUTED METRIC COLLECTION (Edge)
# Deploys the Node Exporter to the Web Server to capture hardware and OS-level metrics.
- name: Install Node Exporter
  hosts: web_server
  become: true
  roles:
    # Industry standard role for exporting Linux system metrics (CPU, RAM, Disk).
    - prometheus.prometheus.node_exporter

# 2. CENTRALIZED MONITORING HUB
# Orchestrates the full observability stack (Prometheus, Grafana, and Docker) on the Monitoring host.
- name: Setup Monitoring Hub
  hosts: monitoring_server
  become: true
  
  # 3. SERVICE CONFIGURATION VARIABLES
  # Defines the administrative credentials and network routing for the visualization layer.
  vars:
    grafana_ini:
      security:
        admin_user: "admin"
        admin_password: "admin"
      server:
        domain: "monitoring.vimalops.com"
        root_url: "https://monitoring.vimalops.com"
        http_port: 3000

    # 4. SCRAPE TARGET DEFINITIONS
    # Instructs Prometheus on which endpoints to poll for metric data.
    custom_monitoring_targets:
      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:9090']
      - job_name: 'web_server_node'
        static_configs:
          - targets: ['10.0.0.5:9100']

  # 5. AUTOMATED COMPONENT DEPLOYMENT
  # Leverages community roles to install the core engine and dashboard tools.
  roles:
    - geerlingguy.docker
    - role: prometheus.prometheus.prometheus
      vars:
        prometheus_scrape_configs: "{{ custom_monitoring_targets }}"
    - grafana.grafana.grafana

  # 6. SECURE EXTERNAL INGRESS (Cloudflare Tunnel)
  # Deploys a Dockerized tunnel to expose the monitoring dashboard securely without opening VPC ports.
  tasks:
    - name: Run Cloudflare Tunnel Container
      community.docker.docker_container:
        name: cloudflared-tunnel
        image: cloudflare/cloudflared:latest
        state: started
        restart_policy: always
        command: "tunnel --no-autoupdate run --token {{ cloudflare_token }}"
        network_mode: host
